<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Novo Atendimento – SOE (ESCOLA CLASSE 16)</title>

  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    body{ background:#f3f4f6; }
    .page-wrap{ max-width: 1080px; margin: 0 auto; padding: 18px 14px; }
    .card{ border-radius: 16px; }
    .input-group .btn{ white-space: nowrap; }
    .badge-soft{ background:#eef2ff; color:#334155; border:1px solid #e5e7eb; }
    .hint-sigilo{
      background:#fff7ed;
      border:1px solid #fed7aa;
      color:#9a3412;
      border-radius:12px;
      padding:10px 12px;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div class="page-wrap">

    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="h4 mb-0">
        <i class="fa-solid fa-user-nurse me-2"></i>Novo Atendimento – SOE
      </h1>
      <div class="d-flex gap-2">
        <a href="{{ url_for('soe.soe_historico') }}" class="btn btn-outline-secondary btn-sm">
          <i class="fa-solid fa-table-list me-1"></i> Histórico
        </a>
        <a href="{{ url_for('dashboard_moderador') }}" class="btn btn-outline-secondary btn-sm">
          <i class="fa-solid fa-arrow-left-long me-1"></i> Voltar
        </a>
      </div>
    </div>

    <div class="card border-0 shadow-sm">
      <div class="card-body">

        <form method="post" action="{{ url_for('soe.soe_novo') }}" class="needs-validation" novalidate>

          <div class="row g-3 mb-1">
            <div class="col-md-7">
              <label class="form-label">Protocolo (opcional, mas único)</label>
              <div class="input-group">
                <input type="text" class="form-control" name="protocolo" id="protocolo" placeholder="Ex.: SOE-20250912-0001" maxlength="40" value="{{ (form and form.protocolo) or '' }}">
                <button class="btn btn-outline-secondary" type="button" id="btn-gerar-protocolo">
                  <i class="fa-solid fa-wand-magic-sparkles"></i> Gerar
                </button>
                <button class="btn btn-outline-primary" type="button" id="btn-checar-protocolo">
                  <i class="fa-solid fa-magnifying-glass"></i> Checar
                </button>
              </div>
              <div class="form-text" id="hint-protocolo">Deixe em branco para não usar. Se preencher, não pode repetir.</div>
            </div>

            <div class="col-md-5">
              <label class="form-label">Responsável presente no atendimento</label>
              <input type="text" class="form-control mb-2" name="responsavel_nome" required
                     placeholder="Digite o nome completo do(a) responsável"
                     value="{{ (form and form.responsavel_nome) or '' }}">
              <label class="form-label">Parentesco</label>
              <select class="form-select" name="responsavel_parentesco" required>
                {% set p = (form and form.responsavel_parentesco) or '' %}
                <option value="" disabled {% if not p %}selected{% endif %}>Selecione</option>
                {% for opt in ['Mãe','Pai','Avó','Avô','Responsável legal','Tio/Tia','Irmão/Irmã','Outro'] %}
                  <option value="{{ opt }}" {% if p == opt %}selected{% endif %}>{{ opt }}</option>
                {% endfor %}
              </select>
              <div class="invalid-feedback">Informe o nome do(a) responsável e o parentesco.</div>
            </div>
          </div>

          <h2 class="h6 text-uppercase text-secondary mt-3 mb-3">Identificação</h2>

          <div class="row g-3">
            <div class="col-md-3">
              <label class="form-label">Turno</label>
              <select id="turno" class="form-select" required>
                <option value="" selected disabled>Selecione</option>
                {% for t in turnos %}
                  <option value="{{ t }}">{{ t }}</option>
                {% endfor %}
              </select>
              <div class="invalid-feedback">Selecione o turno.</div>
            </div>

            <div class="col-md-4">
              <label class="form-label">Turma</label>
              <select id="turma" name="turma_id" class="form-select" required>
                <option value="" selected disabled>Selecione o turno primeiro</option>
              </select>
              <div class="invalid-feedback">Selecione a turma.</div>
            </div>

            <div class="col-md-5">
              <label class="form-label">Aluno(a)</label>
              <select id="aluno" name="aluno_id" class="form-select" required>
                <option value="" selected disabled>Selecione a turma primeiro</option>
              </select>
              <div class="invalid-feedback">Selecione o(a) aluno(a).</div>
            </div>
          </div>

          <div class="row g-3 mt-1">
            <div class="col-md-6">
              <label class="form-label">Orientadora (quem registrou)</label>
              <input type="text" class="form-control" name="orientadora_nome" required placeholder="Nome da Orientadora" value="{{ (form and form.orientadora_nome) or '' }}">
              <div class="invalid-feedback">Informe o nome da orientadora.</div>
            </div>
            <div class="col-md-6">
              <label class="form-label">Data do atendimento</label>
              <input type="date" class="form-control" name="data_atendimento" required value="{{ (form and form.data_atendimento) or '' }}">
              <div class="invalid-feedback">Informe a data do atendimento.</div>
            </div>
          </div>

          <div class="row g-3 mt-1">
            <div class="col-md-3">
              <label class="form-label">Hora do atendimento</label>
              <input type="time" class="form-control" name="hora_atendimento" value="{{ (form and form.hora_atendimento) or '' }}">
              <div class="form-text">Opcional.</div>
            </div>
            <div class="col-md-9">
              <label class="form-label">Assunto (resumo)</label>
              <input type="text" class="form-control" name="assunto" placeholder="Ex.: acompanhamento, faltas, comportamento, comunicação com família..." value="{{ (form and form.assunto) or '' }}">
            </div>
          </div>

          <hr class="my-4">

          <h2 class="h6 text-uppercase text-secondary mb-3">Relato, Combinados e Encaminhamentos</h2>

          <div class="mb-3">
            <label class="form-label">Relato detalhado</label>
            <textarea class="form-control" name="relato" rows="6" required placeholder="Descreva os fatos, escuta das partes, decisões e registros do atendimento...">{{ (form and form.relato) or '' }}</textarea>
            <div class="invalid-feedback">Insira o relato do atendimento.</div>
          </div>

          <div class="mb-3">
            <label class="form-label">Combinados do atendimento (vai para o PDF)</label>
            <textarea class="form-control" name="combinados" rows="4" placeholder="Registre os acordos, responsabilidades e prazos combinados...">{{ (form and form.combinados) or '' }}</textarea>
          </div>

          <div class="mb-2 hint-sigilo">
            <i class="fa-solid fa-shield-halved me-1"></i>
            <strong>Sigilo:</strong> “Encaminhamentos” ficam salvos e aparecem <strong>apenas</strong> na visualização do sistema.
            <strong>Não</strong> entram no PDF.
          </div>

          <div class="mb-3">
            <label class="form-label">Encaminhamentos (SIGILOSO – não vai para o PDF)</label>
            <textarea class="form-control" name="encaminhamentos" rows="4" placeholder="Ex.: Conselho Tutelar, CAPS i, CRAS, Saúde, outros...">{{ (form and form.encaminhamentos) or '' }}</textarea>
          </div>

          <div class="row g-3">
            <div class="col-md-4">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="retorno_previsto" name="retorno_previsto" {% if form and form.retorno_previsto %}checked{% endif %}>
                <label class="form-check-label" for="retorno_previsto">Haverá retorno?</label>
              </div>
            </div>
            <div class="col-md-8">
              <div id="grp-retorno" class="row g-2 {% if not (form and form.retorno_previsto) %}d-none{% endif %}">
                <div class="col-md-6">
                  <label class="form-label">Data e hora do retorno</label>
                  <input type="datetime-local" class="form-control" id="retorno_em" name="retorno_em" value="{{ (form and form.retorno_em) or '' }}">
                </div>
                <div class="col-md-6 d-flex align-items-end">
                  <div class="form-text">Após o retorno, atualize pela edição.</div>
                </div>
              </div>
            </div>
          </div>

          <div class="row g-3 mt-1">
            <div class="col-md-4">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="reuniao_agendada" name="reuniao_agendada" {% if form and form.reuniao_agendada %}checked{% endif %}>
                <label class="form-check-label" for="reuniao_agendada">Agendar reunião com responsáveis?</label>
              </div>
            </div>
            <div class="col-md-8">
              <div id="grp-reuniao" class="row g-2 {% if not (form and form.reuniao_agendada) %}d-none{% endif %}">
                <div class="col-md-6">
                  <label class="form-label">Data e hora da reunião</label>
                  <input type="datetime-local" class="form-control" id="reuniao_data" name="reuniao_data" value="{{ (form and form.reuniao_data) or '' }}">
                </div>
                <div class="col-md-6 d-flex align-items-end">
                  <div class="form-text">A confirmação/realização poderá ser atualizada depois.</div>
                </div>
              </div>
            </div>
          </div>

          <hr class="my-4">

          <div class="d-flex gap-2">
            <a href="{{ url_for('dashboard_moderador') }}" class="btn btn-outline-secondary">
              <i class="fa-solid fa-arrow-left-long me-1"></i> Cancelar
            </a>
            <button class="btn btn-primary">
              <i class="fa-solid fa-floppy-disk me-1"></i> Salvar atendimento (SOE)
            </button>
          </div>

        </form>
      </div>
    </div>
  </div>

<script>
  (function () {
    'use strict';
    document.querySelectorAll('.needs-validation').forEach(form => {
      form.addEventListener('submit', e => {
        if (!form.checkValidity()) { e.preventDefault(); e.stopPropagation(); }
        form.classList.add('was-validated');
      }, false);
    });
  })();

  const inpProto = document.getElementById('protocolo');
  const hintProto = document.getElementById('hint-protocolo');

  document.getElementById('btn-gerar-protocolo').addEventListener('click', () => {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const da = String(d.getDate()).padStart(2,'0');
    const r = Math.floor(Math.random()*9999).toString().padStart(4,'0');
    inpProto.value = `SOE-${y}${m}${da}-${r}`;
    hintProto.className = 'form-text';
    hintProto.textContent = 'Sugestão gerada. Clique em "Checar" para verificar disponibilidade.';
  });

  document.getElementById('btn-checar-protocolo').addEventListener('click', async () => {
    const v = (inpProto.value || '').trim();
    if(!v){
      hintProto.className = 'form-text text-danger';
      hintProto.textContent = 'Informe um protocolo para checar.';
      return;
    }
    try{
      const res = await fetch(`{{ url_for('soe.api_check_protocolo_soe') }}?protocolo=${encodeURIComponent(v)}`);
      const data = await res.json();
      if(data.ok){
        hintProto.className = 'form-text text-success';
        hintProto.textContent = 'Disponível! Você pode usar este protocolo.';
      }else{
        hintProto.className = 'form-text text-danger';
        hintProto.textContent = 'Já existe um atendimento do SOE com esse protocolo. Gere outro.';
      }
    }catch(e){
      hintProto.className = 'form-text text-danger';
      hintProto.textContent = 'Não foi possível checar agora.';
    }
  });

  const chkRet = document.getElementById('retorno_previsto');
  const grpRet = document.getElementById('grp-retorno');
  chkRet.addEventListener('change', () => {
    grpRet.classList.toggle('d-none', !chkRet.checked);
    if (!chkRet.checked) document.getElementById('retorno_em').value = '';
  });

  const chkReu = document.getElementById('reuniao_agendada');
  const grpReu = document.getElementById('grp-reuniao');
  chkReu.addEventListener('change', () => {
    grpReu.classList.toggle('d-none', !chkReu.checked);
    if (!chkReu.checked) document.getElementById('reuniao_data').value = '';
  });

  const selTurno = document.getElementById('turno');
  const selTurma = document.getElementById('turma');
  const selAluno = document.getElementById('aluno');

  selTurno.addEventListener('change', async () => {
    const turno = selTurno.value;
    selTurma.innerHTML = '<option value="" selected disabled>Carregando...</option>';
    selAluno.innerHTML = '<option value="" selected disabled>Selecione a turma primeiro</option>';

    try {
      const res = await fetch(`{{ url_for('soe.api_turmas_soe') }}?turno=${encodeURIComponent(turno)}`);
      const turmas = await res.json();
      selTurma.innerHTML = '<option value="" selected disabled>Selecione</option>';
      turmas.forEach(t => selTurma.insertAdjacentHTML('beforeend', `<option value="${t.id}">${t.nome} – ${t.turno}</option>`));
    } catch (e) {
      selTurma.innerHTML = '<option value="" selected disabled>Erro ao carregar</option>';
      console.error(e);
    }
  });

  selTurma.addEventListener('change', async () => {
    const turmaId = selTurma.value;
    selAluno.innerHTML = '<option value="" selected disabled>Carregando...</option>';
    try {
      const res = await fetch(`{{ url_for('soe.api_alunos_soe') }}?turma_id=${encodeURIComponent(turmaId)}`);
      const alunos = await res.json();
      selAluno.innerHTML = '<option value="" selected disabled>Selecione</option>';
      alunos.forEach(a => selAluno.insertAdjacentHTML('beforeend', `<option value="${a.id}">${a.nome}</option>`));
    } catch (e) {
      selAluno.innerHTML = '<option value="" selected disabled>Erro ao carregar</option>';
      console.error(e);
    }
  });
</script>
</body>
</html>
