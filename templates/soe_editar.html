<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Editar Atendimento (SOE) – ESCOLA CLASSE 16</title>

  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    body{ background:#f3f4f6; }
    .page-wrap{ max-width: 1080px; margin: 0 auto; padding: 18px 14px; }
    .card{ border-radius: 16px; }
    .hint-sigilo{
      background:#fff7ed;
      border:1px solid #fed7aa;
      color:#9a3412;
      border-radius:12px;
      padding:10px 12px;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div class="page-wrap">

    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 class="h4 mb-0">
        <i class="fa-solid fa-pen-to-square me-2"></i>Editar Atendimento (SOE)
      </h1>
      <div class="d-flex gap-2">
        <a href="{{ url_for('soe.soe_ver', atendimento_id=at.id) }}" class="btn btn-outline-secondary btn-sm">
          <i class="fa-solid fa-eye me-1"></i> Ver
        </a>
        <a href="{{ url_for('soe.soe_historico') }}" class="btn btn-outline-secondary btn-sm">
          <i class="fa-solid fa-arrow-left-long me-1"></i> Voltar
        </a>
      </div>
    </div>

    <div class="card border-0 shadow-sm">
      <div class="card-body">

        <form method="post" action="{{ url_for('soe.soe_editar', atendimento_id=at.id) }}" class="needs-validation" novalidate>

          <h2 class="h6 text-uppercase text-secondary mb-3">Identificação</h2>

          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Turma</label>
              <select id="turma" name="turma_id" class="form-select" required>
                <option value="" disabled>Selecione</option>
                {% for tu in turmas %}
                  <option value="{{ tu.id }}" {% if at.turma_id|int == tu.id %}selected{% endif %}>{{ tu.nome }} – {{ tu.turno }}</option>
                {% endfor %}
              </select>
              <div class="invalid-feedback">Selecione a turma.</div>
            </div>

            <div class="col-md-6">
              <label class="form-label">Aluno(a)</label>
              <select id="aluno" name="aluno_id" class="form-select" required>
                {% for a in alunos %}
                  <option value="{{ a.id }}" {% if at.aluno_id|int == a.id %}selected{% endif %}>{{ a.nome }}</option>
                {% endfor %}
              </select>
              <div class="invalid-feedback">Selecione o(a) aluno(a).</div>
            </div>
          </div>

          <div class="row g-3 mt-1">
            <div class="col-md-6">
              <label class="form-label">Responsável presente</label>
              <input type="text" class="form-control mb-2" name="responsavel_nome" required value="{{ at.responsavel_nome }}">
              <label class="form-label">Parentesco</label>
              <select class="form-select" name="responsavel_parentesco" required>
                {% set p = at.responsavel_parentesco or '' %}
                <option value="" disabled {% if not p %}selected{% endif %}>Selecione</option>
                {% for opt in ['Mãe','Pai','Avó','Avô','Responsável legal','Tio/Tia','Irmão/Irmã','Outro'] %}
                  <option value="{{ opt }}" {% if p == opt %}selected{% endif %}>{{ opt }}</option>
                {% endfor %}
              </select>
              <div class="invalid-feedback">Informe o nome do(a) responsável e o parentesco.</div>
            </div>

            <div class="col-md-6">
              <label class="form-label">Orientadora</label>
              <input type="text" class="form-control" name="orientadora_nome" required value="{{ at.orientadora_nome }}">
              <div class="invalid-feedback">Informe o nome da orientadora.</div>
            </div>
          </div>

          <div class="row g-3 mt-1">
            <div class="col-md-4">
              <label class="form-label">Data do atendimento</label>
              <input type="date" class="form-control" name="data_atendimento" required value="{{ at.data_atendimento }}">
              <div class="invalid-feedback">Informe a data do atendimento.</div>
            </div>
            <div class="col-md-4">
              <label class="form-label">Hora do atendimento</label>
              <input type="time" class="form-control" name="hora_atendimento" value="{{ at.hora_atendimento }}">
              <div class="form-text">Opcional.</div>
            </div>
            <div class="col-md-4">
              <label class="form-label">Protocolo</label>
              <input type="text" class="form-control" value="{{ at.protocolo or '' }}" disabled>
              <div class="form-text">O protocolo é fixo após salvar (se foi usado).</div>
            </div>
          </div>

          <div class="row g-3 mt-1">
            <div class="col-md-12">
              <label class="form-label">Assunto</label>
              <input type="text" class="form-control" name="assunto" value="{{ at.assunto or '' }}">
            </div>
          </div>

          <hr class="my-4">

          <h2 class="h6 text-uppercase text-secondary mb-3">Relato, Combinados e Encaminhamentos</h2>

          <div class="mb-3">
            <label class="form-label">Relato detalhado</label>
            <textarea class="form-control" name="relato" rows="6" required>{{ at.relato }}</textarea>
            <div class="invalid-feedback">Insira o relato do atendimento.</div>
          </div>

          <div class="mb-3">
            <label class="form-label">Combinados (vai para o PDF)</label>
            <textarea class="form-control" name="combinados" rows="4">{{ at.combinados or '' }}</textarea>
          </div>

          <div class="mb-2 hint-sigilo">
            <i class="fa-solid fa-shield-halved me-1"></i>
            <strong>Sigilo:</strong> “Encaminhamentos” ficam salvos e aparecem <strong>apenas</strong> na visualização do sistema.
            <strong>Não</strong> entram no PDF.
          </div>

          <div class="mb-3">
            <label class="form-label">Encaminhamentos (SIGILOSO – não vai para o PDF)</label>
            <textarea class="form-control" name="encaminhamentos" rows="4">{{ at.encaminhamentos or '' }}</textarea>
          </div>

          <div class="row g-3">
            <div class="col-md-4">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="retorno_previsto" name="retorno_previsto" {% if at.retorno_previsto %}checked{% endif %}>
                <label class="form-check-label" for="retorno_previsto">Haverá retorno?</label>
              </div>
            </div>
            <div class="col-md-8">
              <div id="grp-retorno" class="row g-2 {% if not at.retorno_previsto %}d-none{% endif %}">
                <div class="col-md-6">
                  <label class="form-label">Data e hora do retorno</label>
                  <input type="datetime-local" class="form-control" id="retorno_em" name="retorno_em" value="{{ at.retorno_em or '' }}">
                </div>
                <div class="col-md-6 d-flex align-items-end">
                  <div class="form-text">Atualize após o retorno, se necessário.</div>
                </div>
              </div>
            </div>
          </div>

          <div class="row g-3 mt-1">
            <div class="col-md-4">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="reuniao_agendada" name="reuniao_agendada" {% if at.reuniao_agendada %}checked{% endif %}>
                <label class="form-check-label" for="reuniao_agendada">Reunião agendada?</label>
              </div>
            </div>
            <div class="col-md-8">
              <div id="grp-reuniao" class="row g-2 {% if not at.reuniao_agendada %}d-none{% endif %}">
                <div class="col-md-6">
                  <label class="form-label">Data e hora da reunião</label>
                  <input type="datetime-local" class="form-control" id="reuniao_data" name="reuniao_data" value="{{ at.reuniao_data or '' }}">
                </div>
                <div class="col-md-6 d-flex align-items-end">
                  <div class="form-text">A confirmação/realização pode ser atualizada depois.</div>
                </div>
              </div>
            </div>
          </div>

          <hr class="my-4">

          <div class="d-flex gap-2">
            <a href="{{ url_for('soe.soe_ver', atendimento_id=at.id) }}" class="btn btn-outline-secondary">
              <i class="fa-solid fa-arrow-left-long me-1"></i> Cancelar
            </a>
            <button class="btn btn-primary">
              <i class="fa-solid fa-floppy-disk me-1"></i> Salvar alterações
            </button>
          </div>

        </form>
      </div>
    </div>
  </div>

<script>
  (function () {
    'use strict';
    document.querySelectorAll('.needs-validation').forEach(form => {
      form.addEventListener('submit', e => {
        if (!form.checkValidity()) { e.preventDefault(); e.stopPropagation(); }
        form.classList.add('was-validated');
      }, false);
    });
  })();

  const chkRet = document.getElementById('retorno_previsto');
  const grpRet = document.getElementById('grp-retorno');
  chkRet.addEventListener('change', () => {
    grpRet.classList.toggle('d-none', !chkRet.checked);
    if (!chkRet.checked) document.getElementById('retorno_em').value = '';
  });

  const chkReu = document.getElementById('reuniao_agendada');
  const grpReu = document.getElementById('grp-reuniao');
  chkReu.addEventListener('change', () => {
    grpReu.classList.toggle('d-none', !chkReu.checked);
    if (!chkReu.checked) document.getElementById('reuniao_data').value = '';
  });

  const selTurma = document.getElementById('turma');
  const selAluno = document.getElementById('aluno');

  selTurma?.addEventListener('change', async () => {
    const turmaId = selTurma.value;
    if(!turmaId){ return; }
    selAluno.innerHTML = '<option value="" selected disabled>Carregando...</option>';
    try{
      const res = await fetch(`{{ url_for('soe.api_alunos_soe') }}?turma_id=${encodeURIComponent(turmaId)}`);
      const alunos = await res.json();
      selAluno.innerHTML = '<option value="" selected disabled>Selecione</option>';
      alunos.forEach(a => selAluno.insertAdjacentHTML('beforeend', `<option value="${a.id}">${a.nome}</option>`));
    }catch(e){
      console.error(e);
    }
  });
</script>
</body>
</html>
